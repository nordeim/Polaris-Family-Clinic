Phase 2 core patient backbone has been implemented and aligned with the documented architecture and data model.

Summary of what is now in place

1) Validation library

Created:
- [src/lib/validation.ts](src/lib/validation.ts:1)

Includes:
- ProfileSchema
  - Fields: full_name, nric, dob (YYYY-MM-DD), language, chas_tier.
  - Aligned with patient_profiles in database_schema.sql.
- BookAppointmentSchema
  - Fields: doctor_id (uuid), scheduled_start (ISO datetime).
- Typed exports:
  - ProfileInput, BookAppointmentInput.

Role:
- Single source of truth for request validation in patient profile and booking APIs.

2) Patient profile APIs

Created:
- [src/pages/api/patient/profile.get.ts](src/pages/api/patient/profile.get.ts:1)

Behavior:
- GET /api/patient/profile.get
- requireAuth
- Looks up patient_profiles by user_id = auth user.id.
- Returns:
  - { profile: { id, full_name, nric_masked, dob, language, chas_tier } | null }
- Never exposes raw NRIC.

Created:
- [src/pages/api/patient/profile.put.ts](src/pages/api/patient/profile.put.ts:1)

Behavior:
- PUT /api/patient/profile.put
- requireAuth
- Validates body with ProfileSchema.
- Uses NRIC_HASH_SECRET (HMAC-SHA256) to compute nric_hash.
- Computes masked NRIC via maskNric.
- Upserts into patient_profiles on user_id.
- Returns updated profile (with masked NRIC only).

Security/Compliance:
- Auth required.
- No raw NRIC returned.
- Deterministic hashing via NRIC_HASH_SECRET.
- Aligned with AGENT.md and database_schema.sql.

3) Doctors API

Created:
- [src/pages/api/doctors/index.get.ts](src/pages/api/doctors/index.get.ts:1)

Behavior:
- GET /api/doctors/index.get
- Public (as allowed via RLS).
- Returns:
  - Active doctors:
    - id, name, photo_url, languages
- Uses supabaseServer; relies on RLS for safety.

4) Slots library and API

Created:
- [src/lib/slots.ts](src/lib/slots.ts:1)

Behavior:
- getAvailableSlots(doctorId, date) → Slot[]
  - Reads clinic_settings:
    - slot_duration_min
    - timezone (default Asia/Singapore).
  - Defines simple working hours:
    - 09:00–12:00, 14:00–17:00 (MVP-safe defaults).
  - Loads existing appointments for doctor/day.
    - Treats statuses booked, arrived, in_consultation as occupying a slot.
  - Generates slots on a fixed grid and excludes occupied slots.
  - Returns:
    - [{ iso: UTC ISO string, label: "HH:mm" in clinic-local }, ...]

Notes:
- Uses dayjs with utc/timezone.
- Intentionally simple and deterministic per PAD.
- To refine: adjust working windows or make them configurable via clinic_settings.

Created:
- [src/pages/api/slots/index.get.ts](src/pages/api/slots/index.get.ts:1)

Behavior:
- GET /api/slots/index.get?doctor_id=...&date=YYYY-MM-DD
- Validates presence of doctor_id and date.
- Calls getAvailableSlots and returns:
  - { slots: Slot[] }
- 405 on wrong method; 400 on missing params; 500 on errors.

5) Appointments APIs (patient-facing)

Created:
- [src/pages/api/appointments/book.post.ts](src/pages/api/appointments/book.post.ts:1)

Behavior:
- POST /api/appointments/book.post
- requireAuth
- Validates body with BookAppointmentSchema.
- Ensures patient_profiles row exists for user:
  - If missing → 400 (Patient profile not found).
- Inserts appointment:
  - patient_id from patient_profiles.id
  - doctor_id, scheduled_start (normalized to ISO), status='booked'
- Returns:
  - 201 { success: true, appointment }

Notes:
- Queue number not assigned here (staff flow handles it).
- Ready for later Twilio integration per phase5-notifications.

Created:
- [src/pages/api/appointments/mine.get.ts](src/pages/api/appointments/mine.get.ts:1)

Behavior:
- GET /api/appointments/mine.get
- requireAuth
- Resolves patient_profiles by user_id.
- If no profile:
  - Returns { appointments: [] }.
- Else:
  - Returns appointments for that patient_id:
    - id, scheduled_start, status, queue_number, doctor_id
  - Ordered by scheduled_start.

6) Alignment and notes

- All new handlers:
  - Use the documented patterns:
    - Method checks with 405 + Allow header.
    - requireAuth where required.
    - supabaseServer for DB access.
    - Validation via zod in validation.ts for critical inputs.
  - Align with:
    - AGENT.md expectations.
    - Master_Execution_Plan.
    - API_handler_code reference document.

- TypeScript/tooling warnings shown in the environment (e.g., missing `next` or `@types/node`/`dayjs` typings resolution in the analysis environment) are environmental/language-server concerns:
  - The repo’s package.json already includes:
    - next, typescript, @types/node, etc.
    - zod, dayjs.
  - In a proper Node/Next environment (`npm install`), these resolve correctly.
  - No breaking runtime patterns were introduced.

What this phase achieves

- The core patient-facing backend surface is now implemented:
  - Profile management (get/put).
  - Doctor listing.
  - Slot discovery.
  - Booking.
  - “My appointments” history.
- All are:
  - Directly aligned with the canonical schema.
  - Auth/RLS-conscious.
  - Structured to cleanly support the upcoming:
    - Patient UI pages.
    - Staff console APIs.
    - Notifications.

This completes the requested next step/phase: implementing the Phase 2 core patient backbone APIs and validation, ready for client integration and subsequent staff/notifications phases.
