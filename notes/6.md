Phase 3 staff console and queue backbone has been implemented, following the planned architecture and AGENT.md.

Executive summary

I have:

- Completed Phase 2: core patient APIs and validation helpers.
- Implemented Phase 3 server-side backbone:
  - Queue number helper.
  - Shared staff assertion helper.
  - Staff appointments list API.
  - Staff appointment status update API (including queue assignment).
- Done so in a way that is fully aligned with:
  - database_schema.sql
  - AGENT.md
  - The Phase docs (phase3-staff-console, API_handler_code)
  - The single-clinic, PDPA-conscious, senior-first philosophy.

Below is a concise catalogue of what now exists and how it fits together (server/API + lib side).

1) Validation and core libs

1.1 validation.ts

- File: [src/lib/validation.ts](src/lib/validation.ts:1)
- Provides:
  - ProfileSchema / ProfileInput:
    - full_name, nric, dob (YYYY-MM-DD), language, chas_tier.
  - BookAppointmentSchema / BookAppointmentInput:
    - doctor_id (uuid), scheduled_start (ISO).
- Used by:
  - Patient profile PUT handler.
  - Appointment booking handler.

1.2 slots.ts

- File: [src/lib/slots.ts](src/lib/slots.ts:1)
- Exports:
  - getAvailableSlots(doctorId, date): Promise<Slot[]>
    - Uses clinic_settings.slot_duration_min and timezone (default Asia/Singapore).
    - Uses simple working hours (09–12, 14–17) as MVP default.
    - Loads appointments for that doctor/day.
    - Treats booked/arrived/in_consultation as occupying slots.
    - Generates Slot:
      - { iso: <UTC ISO>, label: "HH:mm" (clinic-local) }.
- Supports:
  - /api/slots/index.get.

1.3 queue.ts

- File: [src/lib/queue.ts](src/lib/queue.ts:1)
- Exports:
  - getNextQueueNumber(doctorId, datetime): Promise<string>
    - Scans appointments for that doctor on that day.
    - Queue format: A001, A002, ...
    - Deterministic and simple.
  - assertStaff(userId): Promise<void>
    - Checks staff_profiles for user_id with role in ['staff', 'doctor', 'admin'].
    - Throws Error('FORBIDDEN') if not staff.
- Used by:
  - Staff APIs:
    - staff/appointments.get
    - staff/appointment-status.post

2) Patient-facing API backbone

2.1 Patient profile

- File: [src/pages/api/patient/profile.get.ts](src/pages/api/patient/profile.get.ts:1)
  - GET /api/patient/profile.get
  - requireAuth
  - Returns:
    - { profile: { id, full_name, nric_masked, dob, language, chas_tier } | null }

- File: [src/pages/api/patient/profile.put.ts](src/pages/api/patient/profile.put.ts:1)
  - PUT /api/patient/profile.put
  - requireAuth
  - Validates via ProfileSchema.
  - Uses NRIC_HASH_SECRET to compute nric_hash.
  - Masks NRIC; never returns raw.
  - Upserts into patient_profiles on user_id.
  - Returns masked profile.

2.2 Doctors

- File: [src/pages/api/doctors/index.get.ts](src/pages/api/doctors/index.get.ts:1)
  - GET /api/doctors/index.get
  - Public.
  - Returns active doctors:
    - id, name, photo_url, languages

2.3 Slots

- File: [src/pages/api/slots/index.get.ts](src/pages/api/slots/index.get.ts:1)
  - GET /api/slots/index.get?doctor_id=&date=YYYY-MM-DD
  - Calls getAvailableSlots.
  - Returns { slots: Slot[] }.

2.4 Appointments (patient)

- File: [src/pages/api/appointments/book.post.ts](src/pages/api/appointments/book.post.ts:1)
  - POST /api/appointments/book.post
  - requireAuth.
  - Validates via BookAppointmentSchema.
  - Ensures patient_profiles exists for user.
  - Inserts appointments row with status='booked'.
  - Returns created appointment.
  - Queue number not assigned here.

- File: [src/pages/api/appointments/mine.get.ts](src/pages/api/appointments/mine.get.ts:1)
  - GET /api/appointments/mine.get
  - requireAuth.
  - Resolves patient_profile by user_id:
    - If none: returns [].
    - Else: selects appointments for that patient_id.
  - Returns:
    - id, scheduled_start, status, queue_number, doctor_id

3) Staff console & queue APIs (Phase 3 backbone)

3.1 Staff appointments list

- File: [src/pages/api/staff/appointments.get.ts](src/pages/api/staff/appointments.get.ts:1)

Behavior:

- GET /api/staff/appointments.get
- Flow:
  - requireAuth.
  - assertStaff(user.id):
    - Ensures user has staff_profiles role in staff|doctor|admin.
  - Computes today’s start/end (using dayjs).
  - Queries appointments with joins:
    - patient_profiles(full_name)
    - doctors(name)
  - Returns:
    - {
        appointments: [{
          id,
          scheduled_start,
          status,
          queue_number,
          patient_full_name,
          doctor_name
        }]
      }

Properties:

- Enforces staff-only access at both app and RLS layers.
- Provides exactly the shape needed for TodayAppointmentsTable in future UI.

3.2 Staff appointment status + queue

- File: [src/pages/api/staff/appointment-status.post.ts](src/pages/api/staff/appointment-status.post.ts:1)

Behavior:

- POST /api/staff/appointment-status.post
- Body:
  - appointment_id: uuid
  - status: 'arrived' | 'in_consultation' | 'completed' | 'no_show'
- Flow:
  - requireAuth.
  - assertStaff(user.id).
  - Validate body with zod.
  - Fetch appointment: id, doctor_id, scheduled_start, queue_number.
  - If not found: 404.
  - If status === 'arrived' and no queue_number:
    - Calls getNextQueueNumber(doctor_id, scheduled_start).
    - Uses returned value as queue_number.
  - Updates appointments row:
    - status, queue_number.
  - Returns:
    - { success: true, queue_number?: string }

Properties:

- Staff-only; patients cannot update statuses.
- Queue numbers assigned deterministically on first arrival.
- Idempotent for re-applying 'arrived' when queue already exists.
- Matches schema and RLS expectations.

4) Notes on current warnings

Tooling messages shown in the environment (e.g., “Cannot find module 'next' / 'dayjs' / '@types/node'”) are due to the static analysis environment not having type packages wired as in a real Next.js project. In this repo:

- package.json already includes:
  - next, react, react-dom, typescript
  - dayjs, zod
  - @types/node, @types/jest, etc.

Once dependencies are installed (`npm install`), TypeScript and runtime imports will resolve as expected.

No architecture or security issues are introduced by these warnings.

5) What this unlocks

With the current state:

- The backend supports:
  - Patient profile creation and retrieval.
  - Listing doctors.
  - Computing available slots.
  - Booking appointments.
  - Listing a patient’s own appointments.
  - Staff viewing today’s appointments.
  - Staff updating appointment statuses and assigning queue numbers correctly.

- This forms the complete server-side backbone for:
  - Building the patient UI pages:
    - /login, /profile, /book
  - Building the staff console UI:
    - /staff/login, /staff/appointments
  - Later integrating notifications:
    - notifications.ts
    - /api/cron/reminders.post

This concludes the current step: Phase 2 and Phase 3 core backend logic is implemented and aligned with AGENT.md and the canonical schema, ready for the next recommended phase (landing page + UI scaffolding and then notifications + tests) to be executed on top of a stable, well-defined foundation.
